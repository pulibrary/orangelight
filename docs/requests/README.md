# PUL Requests

Requests was once a separate gem housed at https://github.com/pulibrary/requests.  To review code history and issues visit that repository.
The gem was integrated into orangelight in April of 2022 by moving the code from one repository to the other and making minimal changes.  Files in orangelight should be in the same folders in the Request repository.  As this code gets more fully integrated and changes there may not be a corresponding file in the old repository.

## External Interfaces

```mermaid
  graph TD;
  accTitle: External interfaces used to make requests in orangelight.
  accDescr: These interfaces are Alma EDD and Print, Recap/SCSB EDD and Print, Ciasoft Print, Illiad EDD and Print, AEON Print, Borrow Direct Print, Email Print.
      A[Requests]-->B[Alma EDD and Print];
      A[Requests]-->C[Recap/SCSB EDD and Print];
      A[Requests]-->D[Ciasoft Print];
      A[Requests]-->E[Illiad EDD and Print];
      A[Requests]-->F[AEON Print];
      A[Requests]-->G[Borrow Direct Print];
      A[Requests]-->H[Email Print];
```

* [Borrow Direct](https://catalog.princeton.edu/borrow-direct)
  * Used to find items from partners. Has switched to the [ReShare platform](https://projectreshare.org/), and requests are made via Illiad (see below)
* Illiad
  Can cancel request from [orangelight](https://catalog.princeton.edu/account/digitization_requests)
  * Used to request unavailable items that are deemed eligible for a resource sharing request
  * Used to request Digitizations
* [Alma](https://princeton.alma.exlibrisgroup.com/discovery/account?vid=01PRI_INST:Services&lang=EN&section=overview)
  can cancel request by connecting to the URL above
  * Used to request pick-up of available items on the shelf
  * Holds are created for ReCAP Items when physical delivery is requested
  * Holds are requested for Marquand Offsite (clancy) items when physical or digital item is requested
* Clancy (ciasoft)
  All requests on qa and staging go to a test system, so they do not need to be canceled
  * Used to request items from Marquand
    1. Check if items are present in Clancy (all Marquand items not stored in ReCAP)
    1. If present both digital and pick-up request require the physical item to be sent to Princeton campus
* ReCAP
   **Can Not cancel requests sent to ReCAP**
  * Used to request physical pickup of off site materials
    **A hold in Alma is also created for a physical request.  This can and should be canceled during testing.**
  * Used to request a digital copy of off site materials
    **Test should be put in as many fields as possible in a test request.  Usually they note the test and do not do the digitization**

## Basic Usage

### Routes
* When installed a request form can be generated by passing a record identifier within the following route using one of three ID schemes currently available in Orangelight:

1. ```/requests/{mms_id}?mfhd={holding_id}``` Example: https://catalog.princeton.edu/requests/9702169?mfhd=9525518
  a. Optional Params
    1. ```source``` https://catalog.princeton.edu/requests/9702169?mfhd=9525518&source=pulsearch - Facilitates redirection to the source system that generated the request. Currently responds to ```pulsearch``` or ```catalog```, other values will be ignored.
2. ```/requests/{thesis_id}``` Example: https://catalog.princeton.edu/requests/dsp01vx021h212. This will result in a redirect to the AEON system.

## Testing User Roles

Under current campus access policies if you are interactively testing this gem you need to grant your net ID full campus access privileges. You can do by adding your net ID to the campus access list in the bibdata instance you are testing with. To do so:

1. Connect to the server. ```ssh deploy@bibdata-alma-staging1```
2. Change to the directory where the rails app is running. ```cd /opt/marc_liberation/current```
2. Enter the rails console for environment you want to working with. ```RAILS_ENV=production bundle exec rails c```
3. Add your net ID: ```CampusAccess.create(uid:'mynetid')```

## Getting a Count of Requested Clancy Items

1. Start the Rails console in one of the catalog web servers
```
rails c
```

2. Example Commands
```
item = Requests::ClancyItem.new()
item.send(:get_clancy, url: "retrievedlist/v1/20220101/20220401/MQ")
```
3. Canceling a Request
```
body = { "requests": [{ "request_type": "CANCEL", "barcode": "12345678901234", "stop": 'MQ', request_id: "32101103768097-22101008595068-1649085248
"}]}
response = item.send(:post_clancy, url: "circrequests/v1", body: body.to_json)
```

## Architecture

### Rendering the request form

```mermaid
sequenceDiagram
    title Rendering the request form
    actor patron as Patron
    patron->>RequestController: Go to form
    RequestController->>Request: Create new Request object
    Request->>Requestable: Create new Requestable objects
    RequestController->>RequestDecorator: Create new RequestDecorator based on the Request
    RequestDecorator->>RequestableDecorator: Create new RequestableDecorators based on the list of Requestable objects in the Request
    RequestController->>patron: Render the form for the user
```

### Placing the request


```mermaid
sequenceDiagram
    title Placing the request
    actor patron as Patron
    patron->>RequestController: Select options and press submit
    RequestController->>Submission: Create a new Submission
    Submission->>SelectedItemsValidator: Validate using a SelectedItemsValidator object
    Submission->>Service: Create an instance of a Service subclass (e.g. Requests::Submissions::DigitizeItem)
    Service->>RequestMailer: Send emails on success
    RequestController->>RequestMailer: Send emails on failure
    RequestController->>patron: Inform patron how the request went
```
