<script>
    $(document).ready(function(){
        //figgy ajax call using bibid arks
        let arkView = document.getElementById("ark_array_id");
        let result_length, url,result=[], iframeUv3View = [], i, divFrameView = [], onlineTag = [], oReq = [], arkOnline = [], ark_array, ark_length, elem1, elem;

        if (arkView) {
            ark_array = JSON.parse(arkView.dataset.ark);
            ark_length = ark_array.length;
            function createViewer(i, result) {
                result_length = result.length
                for (i = 0; i < result_length; i++) {
                    createElements(i);
                }
                if (ark_length === 1) {
                    elem1 = document.querySelector('div#view_1.intrinsic-container.intrinsic-container-16x9');
                    elem1.parentNode.removeChild(elem1);
                }
            }

            function createElements(i) {
                if (i === 0) {
                        arkOnline = document.querySelectorAll('#availability > div.location--panel.location--online > div > div.panel-body > div');
                        arkOnline[i].querySelector('div > a') ? onlineTag[i] = arkOnline[i].querySelector('div > a') : onlineTag[i] = arkOnline[i].querySelector('li > a')
                        onlineTag[i].href = "#view"; 
                        onlineTag[i].removeAttribute("target");
                        iframeUv3View[i] = document.createElement("iframe");
                        iframeUv3View[i].setAttribute("allowFullScreen", "true");
                        iframeUv3View[i].id = "iframe";
                        iframeUv3View[i].src = "https://figgy.princeton.edu/uv/uv#?manifest=" + result[i];
                        document.getElementById("view").appendChild(iframeUv3View[i]);
                    } else {
                        arkOnline = document.querySelectorAll('#availability > div.location--panel.location--online > div > div.panel-body > div > ul > div.electronic-access');
                        iframeUv3View[i] = document.createElement("iframe");
                        iframeUv3View[i].setAttribute('allowFullScreen', 'true');
                        iframeUv3View[i].id = "iframe_" + i;
                        iframeUv3View[i].src = "https://figgy.princeton.edu/uv/uv#?manifest=" + result[i];
                        document.getElementById("view_" + i).appendChild(iframeUv3View[i]);
                    }
            }

            function loadFiggy(url, callback) {
                    for (i = 0; i < ark_length; i++) {
                        (function(i){
                        oReq[i] = new XMLHttpRequest();
                        oReq[i].open("GET", "https://figgy.princeton.edu/iiif/lookup/" + ark_array[i] + "?no_redirect=true", true);
                        oReq[i].onreadystatechange = function () {
                            if (oReq[i].readyState == 4) {
                                if (oReq[i].status == 200) {
                                    result.push(JSON.parse(oReq[i].response)["url"]);
                                    callback(i, result);
                                } else {
                                    if (ark_length === 1) {
                                        elem = document.querySelector('div#view.intrinsic-container.intrinsic-container-16x9');
                                        elem.parentNode.removeChild(elem);
                                        elem1 = document.querySelector("div#view_1.intrinsic-container.intrinsic-container-16x9");
                                        elem1.parentNode.removeChild(elem1);
                                    } else {
                                        if (i === 0) {
                                            elem = document.querySelector('div#view.intrinsic-container.intrinsic-container-16x9');
                                            elem.parentNode.removeChild(elem);
                                        }
                                        if (i === 1) {
                                            elem1 = document.querySelector("div#view_1.intrinsic-container.intrinsic-container-16x9");
                                            elem1.parentNode.removeChild(elem1);
                                        }
                                    }
                                }
                            }
                        };
                        oReq[i].send(null);
                        })(i);
                    }
            }
            loadFiggy(url, createViewer);
        }
    });
</script>
